var ot=n=>{throw TypeError(n)};var kt=(n,t,e)=>t.has(n)||ot("Cannot "+e);var b=(n,t,e)=>t.has(n)?ot("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e);var h=(n,t,e)=>(kt(n,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class Mt{constructor(){this.element=document.getElementById("carCanvas"),this.context=this.element.getContext("2d"),this.element.width=window.devicePixelRatio*(window.innerWidth*.6-20),this.element.height=window.devicePixelRatio*(window.innerHeight-20)}clear(){this.context.clearRect(0,0,this.element.width,this.element.height)}writeScore(t){this.context.fillStyle="white",this.context.font="50px Arial",this.context.textAlign="center",this.context.fillText(`Score: ${t.toFixed(2)}`,this.element.width/2,this.element.height/2)}}const a=new Mt;class o{constructor(t,e){this.x=t,this.y=e}magnitude(){return Math.sqrt(this.x**2+this.y**2)}normalize(){const t=this.magnitude();return t!=0?new o(this.x/t,this.y/t):new o(0,0)}add(t){return new o(this.x+t.x,this.y+t.y)}subtract(t){return new o(this.x-t.x,this.y-t.y)}mult(t){return new o(this.x*t,this.y*t)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}applyRotMatrix(t){return new o(Math.cos(t)*this.x+Math.sin(t)*this.y,-Math.sin(t)*this.x+Math.cos(t)*this.y)}draw(t,e,i="black",s=1){const r=t+this.x*s,c=e+this.y*s;a.context.beginPath(),a.context.moveTo(t,e),a.context.lineTo(r,c),a.context.strokeStyle=i,a.context.stroke(),a.context.closePath()}}var W,lt;class It{constructor(t,e,i,s){b(this,W);this.position=t,this.velocity=e,this.acceleration=i,this.netacceleration=i,this.friction=100,this.frictionpassive=100,this.orientation=s,this.direction=new o(-Math.sin(this.orientation),Math.cos(this.orientation))}throttleUp(){this.acceleration=this.direction.mult(550)}throttleDown(){this.acceleration=new o(0,0)}brakeDown(){this.frictionpassive=550}brakeUp(){this.frictionpassive=100}left(){this.orientation-=.025,this.direction=new o(-Math.sin(this.orientation),Math.cos(this.orientation))}right(){this.orientation+=.025,this.direction=new o(-Math.sin(this.orientation),Math.cos(this.orientation))}tick(t){h(this,W,lt).call(this),this.velocity=this.velocity.add(this.netacceleration.mult(t)),this.velocity=this.velocity.applyRotMatrix(this.velocity.normalize().cross(this.direction)*-.005),this.position=this.position.add(this.velocity.mult(t))}}W=new WeakSet,lt=function(){this.friction=this.frictionpassive+Math.abs(this.velocity.normalize().cross(this.direction))*(150+this.frictionpassive*.5),this.velocity.magnitude()>2?this.netacceleration=this.acceleration.subtract(this.velocity.normalize().mult(this.friction)):(this.velocity=new o(0,0),this.netacceleration=this.acceleration)};var j,ct;class Pt{constructor(t=!0){b(this,j);this.throttle=!1,this.left=!1,this.right=!1,this.brake=!1,t&&this.enableKeyInputs()}enableKeyInputs(){h(this,j,ct).call(this)}}j=new WeakSet,ct=function(){document.onkeydown=t=>{switch(t.key){case"w":this.throttle=!0;break;case"a":this.left=!0;break;case"d":this.right=!0;break;case"s":this.brake=!0;break}},document.onkeyup=t=>{switch(t.key){case"w":this.throttle=!1;break;case"a":this.left=!1;break;case"d":this.right=!1;break;case"s":this.brake=!1;break}}};var x,F,ut;class dt{constructor(t,e,i){b(this,x);this.shape=t,this.points=new Array(t.length),this.center=e,this.rotation=i;for(let s=0;s<t.length;s++)this.points[s]=t[s].applyRotMatrix(-i).add(e)}intersects(t){for(let e=0;e<this.points.length;e++)for(let i=0;i<t.points.length;i++)if(h(this,x,ut).call(this,this.points[e],this.points[(e+1)%this.points.length],t.points[i],t.points[(i+1)%t.points.length]))return!0}set(t,e){this.center=t,this.rotation=e}draw(t,e){for(let i=0;i<this.shape.length;i++)this.points[i]=this.shape[i].applyRotMatrix(-this.rotation).add(this.center);t.beginPath(),t.moveTo(this.points[this.points.length-1].x,this.points[this.points.length-1].y);for(let i=0;i<this.points.length;i++)t.lineTo(this.points[i].x,this.points[i].y);t.closePath(),t.fillStyle=e,t.fill()}}x=new WeakSet,F=function(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)},ut=function(t,e,i,s){return h(this,x,F).call(this,t,i,s)!=h(this,x,F).call(this,e,i,s)&&h(this,x,F).call(this,t,e,i)!=h(this,x,F).call(this,t,e,s)};class Tt{lerp(t,e,i){return t+(e-t)*i}getIntersection(t,e,i,s){const r=(s.x-i.x)*(t.y-i.y)-(s.y-i.y)*(t.x-i.x),c=(i.y-t.y)*(t.x-e.x)-(i.x-t.x)*(t.y-e.y),w=(s.y-i.y)*(e.x-t.x)-(s.x-i.x)*(e.y-t.y);if(w!=0){const m=r/w,p=c/w;if(m>=0&&m<=1&&p>=0&&p<=1)return{x:this.lerp(t.x,e.x,m),y:this.lerp(t.y,e.y,m),offset:m}}return null}}const N=new Tt;var P,J,gt;class Rt{constructor(t){b(this,P);this.car=t,this.rayCount=7,this.rayLength=200,this.raySpread=Math.PI,h(this,P,J).call(this),this.readings=[]}update(t){h(this,P,J).call(this),this.readings=[];for(let e=0;e<this.rayCount;e++)this.readings.push(h(this,P,gt).call(this,this.rays[e],t))}draw(t){for(let e=0;e<this.rayCount;e++){let i=this.rays[e][1];this.readings[e]&&(i=this.readings[e]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[e][0].x,this.rays[e][0].y),t.lineTo(i.x,i.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="red",t.moveTo(i.x,i.y),t.lineTo(this.rays[e][1].x,this.rays[e][1].y),t.stroke()}}}P=new WeakSet,J=function(){this.rays=[];for(let t=0;t<this.rayCount;t++){const e=N.lerp(this.raySpread/2,-this.raySpread/2,this.rayCount==1?.5:t/(this.rayCount-1))-this.car.state.orientation+3.14,i={x:this.car.state.position.x,y:this.car.state.position.y},s={x:this.car.state.position.x-Math.sin(e)*this.rayLength,y:this.car.state.position.y-Math.cos(e)*this.rayLength};this.rays.push([i,s])}},gt=function(t,e){let i=[];for(let s=0;s<e.length;s++)for(let r=0;r<e[s].polygon.points.length;r++){const c=N.getIntersection(t[0],t[1],e[s].polygon.points[r],e[s].polygon.points[(r+1)%e[s].polygon.points.length]);c&&i.push(c)}if(i.length==0)return null;{const s=i.map(c=>c.offset),r=Math.min(...s);return i.find(c=>c.offset==r)}};var C,ft,wt;class H{constructor(t){this.layers=[];for(let e=0;e<t.length-1;e++)this.layers.push(new R(t[e],t[e+1]))}static feedForward(t,e){let i=R.feedForward(t,e.layers[0]);for(let s=1;s<e.layers.length-1;s++)i=R.feedForward(i,e.layers[s]).map(h(this,C,ft));return i=R.feedForward(i,e.layers[e.layers.length-1]).map(h(this,C,wt)),i}static mutate(t,e=.1){t.layers.forEach(i=>{for(let s=0;s<i.biases.length;s++)i.biases[s]=N.lerp(i.biases[s],Math.random()*2-1,e);for(let s=0;s<i.inputs.length;s++)for(let r=0;r<i.outputs.length;r++)i.weights[s][r]=N.lerp(i.weights[s][r],Math.random()*2-1,e)})}}C=new WeakSet,ft=function(t){return Math.max(0,t)},wt=function(t){return 1/(1+Math.exp(-t))>.5},b(H,C);var q,mt;const U=class U{constructor(t,e){var i;this.inputs=new Array(t),this.outputs=new Array(e),this.biases=new Array(e),this.weights=[];for(let s=0;s<t;s++)this.weights.push(new Array(e));h(i=U,q,mt).call(i,this)}static feedForward(t,e){for(let i=0;i<e.inputs.length;i++)e.inputs[i]=t[i];for(let i=0;i<e.outputs.length;i++){let s=e.biases[i];for(let r=0;r<e.inputs.length;r++)s+=e.weights[r][i]*e.inputs[r];e.outputs[i]=s}return e.outputs}};q=new WeakSet,mt=function(t){for(let e=0;e<t.inputs.length;e++)for(let i=0;i<t.outputs.length;i++)t.weights[e][i]=Math.random()*2-1;for(let e=0;e<t.biases.length;e++)t.biases[e]=Math.random()*2-1},b(U,q);let R=U;var K,yt;class Nt{constructor(t,e,i,s,r=0,c=!1,w=!1){b(this,K);this.w=i,this.h=s,this.state=new It(new o(t,e),new o(0,0),new o(0,0),r),this.controls=new Pt(!w),this.show_vectors=c,this.sensor=new Rt(this),this.brain=new H([this.sensor.rayCount,5,5,4]),this.useBrain=w,this.polygon=new dt([new o(-this.w/2,this.h/2),new o(-this.w/2,-this.h/2),new o(this.w/2,-this.h/2),new o(this.w/2,this.h/2)],this.state.position,this.state.orientation),this.score=0,this.lastscore=0,this.laps=0,this.crashed=!1}getScore(){this.lastscore=this.score;const t=a.element.width,e=a.element.height,i=this.state.position.subtract(new o(t/2,e/2));return this.score=Math.atan2(i.x,i.y),this.lastscore>1&&this.score<-1&&(this.laps+=1),this.lastscore<-1&&this.score>1&&(this.laps-=1),(this.score/6.28+this.laps)*100}step(t,e){if(this.crashed)this.state.velocity=new o(0,0),this.state.acceleration=new o(0,0);else{h(this,K,yt).call(this),this.state.tick(t),this.polygon.set(this.state.position,this.state.orientation),this.sensor.update(e);let i=this.sensor.readings.map(r=>r==null?0:1-r.offset);const s=H.feedForward(i,this.brain);this.useBrain&&(this.controls.throttle=s[0],this.controls.left=s[1],this.controls.brake=s[2],this.controls.right=s[3])}}draw(t,e,i){if(this.polygon.draw(t,e),i&&this.sensor.draw(t),this.show_vectors){const s=this.state.position.x,r=this.state.position.y;this.state.velocity.draw(s,r,"green",this.w/60),this.state.netacceleration.draw(s,r,"red",this.w/60),this.state.direction.draw(s,r,"black",this.w*2)}}}K=new WeakSet,yt=function(){this.controls.brake?this.state.brakeDown():this.state.brakeUp(),this.controls.throttle?this.state.throttleUp():this.state.throttleDown(),this.controls.left&&this.state.left(),this.controls.right&&this.state.right()};class Ct{constructor(){this.element=document.getElementById("networkCanvas"),this.context=this.element.getContext("2d"),this.element.width=window.devicePixelRatio*(window.innerWidth*.4-10),this.element.height=window.devicePixelRatio*(window.innerHeight-20)}clear(){this.context.clearRect(0,0,this.element.width,this.element.height)}drawControls(){this.context.clearRect(0,0,this.element.width,this.element.height),this.context.fillStyle="white",this.context.font="50px Arial",this.context.textAlign="center",this.context.fillText("W: Throttle",this.element.width/2,this.element.height*.2),this.context.fillText("A: Left",this.element.width/2,this.element.height*.4),this.context.fillText("S: Brake",this.element.width/2,this.element.height*.6),this.context.fillText("D: Right",this.element.width/2,this.element.height*.8)}}const z=new Ct,Lt=new o(0,0);class rt{constructor(t){this.polygon=new dt(t,Lt,0)}draw(t,e){this.polygon.draw(t,e)}}var y,X,Y,E;const v=class v{static drawNetwork(t,e){const c=t.canvas.width-100,w=t.canvas.height-50*2,m=w/e.layers.length;for(let p=e.layers.length-1;p>=0;p--){const I=50+N.lerp(w-m,0,e.layers.length==1?.5:p/(e.layers.length-1));v.drawLevel(t,e.layers[p],50,I,c,m,p==e.layers.length-1?["🠉","🠈","🠋","🠊"]:[])}}static drawLevel(t,e,i,s,r,c,w){var D,V,_,tt,et,it,st,nt;const m=i+r,p=s+c,{inputs:I,outputs:L,weights:Z,biases:St}=e;for(let d=0;d<I.length;d++)for(let f=0;f<L.length;f++)Math.abs(Z[d][f])>.05&&(t.beginPath(),t.moveTo(h(D=v,y,E).call(D,I,d,i,m),p),t.lineTo(h(V=v,y,E).call(V,L,f,i,m),s),t.lineWidth=2,t.strokeStyle=h(_=v,y,X).call(_,Z[d][f]),t.stroke());const k=18;for(let d=0;d<I.length;d++){const f=h(tt=v,y,E).call(tt,I,d,i,m);t.beginPath(),t.arc(f,p,k,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(f,p,k*.6,0,Math.PI*2),t.fillStyle=h(et=v,y,Y).call(et,I[d]),t.fill()}for(let d=0;d<L.length;d++){const f=h(it=v,y,E).call(it,L,d,i,m);t.beginPath(),t.arc(f,s,k,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(f,s,k*.6,0,Math.PI*2),t.fillStyle=h(st=v,y,Y).call(st,L[d]),t.fill(),t.beginPath(),t.lineWidth=2,t.arc(f,s,k*.8,0,Math.PI*2),t.strokeStyle=h(nt=v,y,X).call(nt,St[d]),t.setLineDash([3,3]),t.stroke(),t.setLineDash([]),w[d]&&(t.beginPath(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="black",t.strokeStyle="white",t.font=k*1.5+"px Arial",t.fillText(w[d],f,s+k*.1),t.lineWidth=.5,t.strokeText(w[d],f,s+k*.1))}}};y=new WeakSet,X=function(t){return t<-.7?"#ff0000":t<-.3?"#aa0000":t<.3?"#000055":t<.7?"#0000aa":"#0000ff"},Y=function(t){return t<=0?"#191b1c":t<=.2?"#3C4142":t<=.4?"#7e8182":t<=.6?"#a1a3a4":t<=.8?"#d4d6d7":"#ffffff"},E=function(t,e,i,s){return N.lerp(i,s,t.length==1?.5:e/(t.length-1))},b(v,y);let G=v;const Bt=.00625;let M,g;const l=a.element.width,u=a.element.height;let pt=0,$=1e3;const B=[new rt([new o(l*.8,u*.05),new o(l*.95,u*.2),new o(l*.95,u*.8),new o(l*.8,u*.95),new o(l*.2,u*.95),new o(l*.05,u*.8),new o(l*.05,u*.2),new o(l*.2,u*.05),new o(l*.8,u*.05),new o(l*.8,0),new o(0,0),new o(0,u),new o(l,u),new o(l,0),new o(l*.8,0)]),new rt([new o(l*.3,u*.2),new o(l*.7,u*.2),new o(l*.8,u*.3),new o(l*.8,u*.7),new o(l*.7,u*.8),new o(l*.3,u*.8),new o(l*.2,u*.7),new o(l*.2,u*.3)])];var T=void 0;let S=!1;const Ft=n=>{const t=[];for(let e=0;e<n;e++)t.push(new Nt(a.element.width*.5,a.element.height*.875,a.element.width*.015,a.element.width*.035,-1.57,0,S));return t},Et=()=>{localStorage.setItem("savedNetwork",JSON.stringify(M.brain)),console.log("Saved Currently Highlighted Car")},At=()=>{localStorage.removeItem("savedNetwork"),console.log("Deleted Car in Local Storage")},vt=()=>{T?(cancelAnimationFrame(T),T=void 0,ht(),T=requestAnimationFrame(Q)):(ht(),T=requestAnimationFrame(Q))},Ot=()=>{if(localStorage.getItem("savedNetwork")){const n=JSON.parse(localStorage.getItem("savedNetwork"));for(let t=0;t<$;t++)g[t].brain=JSON.parse(localStorage.getItem("savedNetwork")),H.mutate(g[t].brain,pt);M.brain=n}},ht=()=>{localStorage.getItem("mutationRate")&&(pt=localStorage.getItem("mutationRate")),localStorage.getItem("carCount")&&($=localStorage.getItem("carCount")),g=Ft(S?$:1),M=g[0],S&&Ot()},Q=()=>{a.clear();for(let n=0;n<B.length;n++)B[n].draw(a.context,"#222222");a.context.globalAlpha=.5;for(let n=0;n<g.length;n++){g[n].step(Bt,B);for(let t=0;t<B.length;t++)B[t].polygon.intersects(g[n].polygon)&&(g[n].crashed=!0);g[n].draw(a.context,g[n].crashed?"gray":"lightblue",0)}for(let n=0;n<g.length;n++)g[n].getScore()>M.getScore()&&!g[n].crashed&&(M=g[n]);a.context.globalAlpha=1,g[0].draw(a.context,"green",S),M.draw(a.context,"blue",S),a.writeScore(M.getScore()),S?(z.clear(),G.drawNetwork(z.context,M.brain)):z.drawControls(),T=requestAnimationFrame(Q)};var A=document.getElementById("inputMut"),bt=document.getElementById("mutText"),O=document.getElementById("inputN"),xt=document.getElementById("NText");if(localStorage.getItem("mutationRate")){const n=localStorage.getItem("mutationRate");A.value=n*100,bt.innerHTML=parseFloat(A.value).toFixed(4)}if(localStorage.getItem("carCount")){const n=localStorage.getItem("carCount");O.value=n,xt.innerHTML=O.value}A.oninput=()=>{bt.innerHTML=parseFloat(A.value).toFixed(4),localStorage.setItem("mutationRate",A.value/100)};O.oninput=()=>{xt.innerHTML=O.value,localStorage.setItem("carCount",O.value)};const Ht=document.getElementById("saveButton"),Wt=document.getElementById("deleteButton"),jt=document.getElementById("restartButton"),at=document.getElementById("switchMode");document.getElementById("modeIcon");Ht.addEventListener("click",Et);Wt.addEventListener("click",At);jt.addEventListener("click",vt);at.addEventListener("click",()=>{S=!S,at.innerText=S?"🤖":"👩"});vt();
